<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebOS 2026</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent: #3b82f6;
            --accent-rgb: 59, 130, 246;
            --danger: #ef4444;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --z-desktop: 10;
            --z-window: 100;
            --z-dock: 1000;
            --z-modal: 2000;
            --z-tooltip: 3000;
            --animation-speed: 0.2s;
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --glass-bg: rgba(17, 24, 39, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: var(--font-main); background-color: #000; }
        
        /* Wallpaper */
        #wallpaper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: background 0.5s ease;
            z-index: 1;
        }

        /* Footer */
        #system-footer {
            position: absolute; bottom: 5px; right: 10px;
            color: rgba(255, 255, 255, 0.4); font-size: 11px;
            z-index: 5; pointer-events: none; font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Selection Box */
        #selection-box {
            position: absolute; border: 1px solid rgba(255,255,255,0.5); background: rgba(59, 130, 246, 0.2);
            display: none; pointer-events: none; z-index: var(--z-desktop);
        }

        /* Top Bar */
        #top-bar {
            position: absolute; top: 0; left: 0; right: 0; height: 32px;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px; color: white; font-size: 13px; z-index: var(--z-dock);
        }
        .bar-group { display: flex; gap: 12px; align-items: center; }

        /* Desktop Icons */
        #desktop-grid {
            position: absolute; top: 32px; left: 0; bottom: 60px; right: 0;
            z-index: var(--z-desktop);
        }
        .desktop-icon {
            position: absolute; /* Changed to absolute for dragging */
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            cursor: pointer; border-radius: 4px; transition: background 0.1s;
            width: 80px; height: 90px;
            touch-action: none;
        }
        .desktop-icon:hover, .desktop-icon.selected { background: rgba(255,255,255,0.2); }
        .desktop-icon svg { width: 42px; height: 42px; margin-bottom: 4px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); pointer-events: none; }
        .desktop-icon span { font-size: 12px; text-align: center; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; pointer-events: none; }

        /* Windows */
        .window {
            position: absolute; background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
            overflow: hidden; opacity: 0; transform: scale(0.95);
            transition: opacity 0.2s, transform 0.2s, width 0.1s, height 0.1s, top 0.1s, left 0.1s;
            color: var(--text-primary); min-width: 200px; min-height: 150px;
        }
        .window.visible { opacity: 1; transform: scale(1); }
        .window.maximized { top: 32px !important; left: 0 !important; width: 100% !important; height: calc(100% - 32px - 60px) !important; border-radius: 0; transition: all 0.2s ease; }
        .window.minimized { opacity: 0; transform: scale(0.5) translateY(200px); pointer-events: none; }
        
        .window-header {
            height: 36px; display: flex; align-items: center; padding: 0 12px;
            background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--glass-border);
            cursor: default; touch-action: none;
        }
        .window-controls { display: flex; gap: 8px; margin-right: 12px; }
        .win-btn { width: 12px; height: 12px; border-radius: 50%; border: none; cursor: pointer; }
        .win-close { background: #ff5f56; } .win-min { background: #ffbd2e; } .win-max { background: #27c93f; }
        .window-title { flex: 1; font-size: 13px; font-weight: 500; text-align: center; pointer-events: none; }
        
        .window-content { flex: 1; overflow: auto; position: relative; padding: 16px; user-select: text; }
        
        /* Resize Handles */
        .resize-handle { position: absolute; z-index: 10; }
        .r-n { top: -3px; left: 5px; right: 5px; height: 6px; cursor: ns-resize; }
        .r-s { bottom: -3px; left: 5px; right: 5px; height: 6px; cursor: ns-resize; }
        .r-e { top: 5px; bottom: 5px; right: -3px; width: 6px; cursor: ew-resize; }
        .r-w { top: 5px; bottom: 5px; left: -3px; width: 6px; cursor: ew-resize; }
        .r-se { bottom: -3px; right: -3px; width: 10px; height: 10px; cursor: nwse-resize; }

        /* Dock */
        #dock-container {
            position: absolute; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; z-index: var(--z-dock);
        }
        #dock {
            background: rgba(255,255,255,0.25); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 16px;
            padding: 8px 12px; display: flex; gap: 12px; align-items: flex-end;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: transform 0.2s;
        }
        .dock-item {
            width: 48px; height: 48px; border-radius: 10px; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative; background: var(--bg-primary);
            display: flex; align-items: center; justify-content: center;
        }
        .dock-item:hover { transform: scale(1.1) translateY(-5px); }
        .dock-item.active::after {
            content: ''; position: absolute; bottom: -6px; width: 4px; height: 4px;
            background: white; border-radius: 50%;
        }
        .dock-item svg { width: 32px; height: 32px; }

        /* Snap Overlay */
        #snap-overlay {
            position: absolute; background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3); border-radius: 8px;
            pointer-events: none; z-index: 90; display: none;
            transition: all 0.1s;
        }

        /* App Specific Styles */
        .app-input { width: 100%; padding: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.05); border-radius: 4px; color: inherit; }
        .app-btn { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .app-btn:hover { opacity: 0.9; }
        
        /* Notes App */
        .note-list { border-right: 1px solid var(--glass-border); width: 150px; height: 100%; overflow-y: auto; }
        .note-editor { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .note-area { flex: 1; background: transparent; border: none; resize: none; outline: none; padding: 10px; color: inherit; font-family: monospace; }
        
        /* Calculator */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; height: 100%; }
        .calc-display { grid-column: span 4; background: rgba(0,0,0,0.1); padding: 16px; text-align: right; font-size: 24px; border-radius: 4px; }
        .calc-btn { background: rgba(255,255,255,0.1); border: none; border-radius: 4px; font-size: 18px; cursor: pointer; color: inherit; }
        .calc-btn.op { background: var(--accent); color: white; }
        
        /* Calendar */
        .cal-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day { padding: 8px; cursor: pointer; border-radius: 4px; }
        .cal-day:hover { background: rgba(0,0,0,0.05); }
        .cal-day.today { background: var(--accent); color: white; }
        .cal-event { font-size: 10px; background: var(--accent); color: white; border-radius: 2px; margin-top: 2px; }

        /* Files */
        .file-crumb { padding: 8px; border-bottom: 1px solid var(--glass-border); }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; padding: 10px; }
        .file-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; border-radius: 4px; }
        .file-item:hover { background: rgba(0,0,0,0.05); }
        .file-item svg { width: 32px; height: 32px; margin-bottom: 4px; color: var(--accent); }

        /* Terminal */
        .term-wrap { background: #111; color: #33ff00; font-family: 'Courier New', monospace; height: 100%; display: flex; flex-direction: column; padding: 8px; font-size: 14px; }
        .term-out { flex: 1; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        .term-line { display: flex; align-items: center; margin-top: 5px; }
        .term-prompt { margin-right: 8px; color: #ff00ff; font-weight: bold; }
        .term-input { background: transparent; border: none; color: inherit; flex: 1; outline: none; font-family: inherit; font-size: inherit; }

        /* Paint */
        .paint-toolbar { padding: 8px; display: flex; gap: 8px; background: rgba(0,0,0,0.05); border-bottom: 1px solid var(--glass-border); }
        .color-pick { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); cursor: pointer; }
        .color-pick.active { border-color: var(--text-primary); transform: scale(1.1); }

        /* Command Palette */
        #cmd-palette {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, 0);
            width: 500px; max-width: 90%; background: var(--bg-primary);
            border: 1px solid var(--glass-border); border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); z-index: var(--z-modal);
            display: none; flex-direction: column; overflow: hidden;
        }
        #cmd-input { width: 100%; padding: 16px; border: none; background: transparent; font-size: 18px; outline: none; color: var(--text-primary); border-bottom: 1px solid var(--glass-border); }
        #cmd-results { max-height: 300px; overflow-y: auto; }
        .cmd-item { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .cmd-item:hover, .cmd-item.active { background: var(--accent); color: white; }

        /* Lock Screen */
        #lock-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(20px);
            z-index: var(--z-modal); display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; transition: transform 0.3s ease-in-out;
        }
        #lock-screen.unlocked { transform: translateY(-100%); }
        #lock-clock { font-size: 64px; font-weight: 200; margin-bottom: 16px; }
        
        /* Notifications */
        #toast-container { position: absolute; bottom: 70px; right: 20px; z-index: var(--z-tooltip); display: flex; flex-direction: column; gap: 8px; }
        .toast { background: var(--bg-primary); color: var(--text-primary); padding: 12px 20px; border-radius: 8px; box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease; border-left: 4px solid var(--accent); }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Wallpaper -->
<div id="wallpaper"></div>
<div id="system-footer">Arnav Dugad © 2025</div>
<div id="selection-box"></div>

<!-- Desktop -->
<div id="desktop-grid"></div>
<div id="snap-overlay"></div>

<!-- Windows Container -->
<div id="windows-layer"></div>

<!-- UI Elements -->
<div id="top-bar">
    <div class="bar-group">
        <span style="font-weight: 700;">WebOS</span>
        <span id="top-date">Jan 1</span>
    </div>
    <div class="bar-group">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12" y2="20"></line></svg>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect><line x1="22" y1="11" x2="22" y2="13"></line></svg>
        <span id="top-clock">12:00</span>
        <button onclick="System.lock()" style="background:none; border:none; color:white; cursor:pointer;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        </button>
    </div>
</div>

<div id="dock-container">
    <div id="dock"></div>
</div>

<div id="cmd-palette">
    <input type="text" id="cmd-input" placeholder="Type a command...">
    <div id="cmd-results"></div>
</div>

<div id="lock-screen">
    <div id="lock-clock">12:00</div>
    <div style="font-size: 18px; margin-bottom: 20px;" id="lock-date">Monday, January 1</div>
    <input type="password" id="pin-input" placeholder="Enter PIN (1234)" style="padding: 10px; border-radius: 20px; border: none; text-align: center; width: 150px;">
    <div style="margin-top: 20px; font-size: 12px; opacity: 0.7;">Click input and Press Enter</div>
    <div style="margin-top: auto; padding-bottom: 20px; opacity: 0.5; font-size: 12px;">Arnav Dugad © 2025</div>
</div>

<div id="toast-container"></div>
<div id="context-menu" style="display:none; position:fixed; background:var(--bg-primary); border:1px solid var(--glass-border); padding:5px; border-radius:6px; z-index: var(--z-modal); box-shadow: var(--shadow-lg);">
    <div class="cmd-item" onclick="Apps.notes.open()">New Note</div>
    <div class="cmd-item" onclick="Apps.files.open()">New Folder</div>
    <div class="cmd-item" onclick="Apps.terminal.open()">Open Terminal</div>
    <div class="cmd-item" onclick="System.toggleTheme()">Toggle Theme</div>
</div>

<script>
/**
 * WebOS 2026 Core Engine
 */

// --- UTILS ---
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);
const uuid = () => Math.random().toString(36).substr(2, 9);
const LS = {
    get: (key, def) => {
        try { return JSON.parse(localStorage.getItem(`webos_${key}`)) || def; } 
        catch { return def; }
    },
    set: (key, val) => localStorage.setItem(`webos_${key}`, JSON.stringify(val))
};

// --- ICONS (SVG Strings) ---
const Icons = {
    notes: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
    calc: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line></svg>',
    calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
    files: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>',
    music: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
    settings: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',
    file: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>',
    term: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>',
    paint: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>'
};

// --- AUDIO ENGINE ---
const AudioEngine = {
    ctx: null,
    init: () => {
        if (!AudioEngine.ctx) {
            AudioEngine.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
    },
    playTone: (freq, type = 'sine', duration = 0.1) => {
        if (!AudioEngine.ctx) AudioEngine.init();
        if (AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();
        const osc = AudioEngine.ctx.createOscillator();
        const gain = AudioEngine.ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(AudioEngine.ctx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, AudioEngine.ctx.currentTime + duration);
        osc.stop(AudioEngine.ctx.currentTime + duration);
    }
};

// --- WINDOW MANAGER ---
class WindowManager {
    constructor() {
        this.windows = {};
        this.activeWindow = null;
        this.zIndex = 100;
        this.snapState = null;
        this.setupInput();
    }

    create(appId, title, contentFn, options = {}) {
        const id = uuid();
        const win = document.createElement('div');
        win.className = 'window';
        win.id = id;
        win.style.width = (options.width || 600) + 'px';
        win.style.height = (options.height || 400) + 'px';
        
        // Random placement offset
        const offset = Object.keys(this.windows).length * 20;
        win.style.top = (50 + offset) + 'px';
        win.style.left = (50 + offset) + 'px';

        win.innerHTML = `
            <div class="window-header">
                <div class="window-controls">
                    <button class="win-btn win-close" onclick="WM.close('${id}')"></button>
                    <button class="win-btn win-min" onclick="WM.minimize('${id}')"></button>
                    <button class="win-btn win-max" onclick="WM.toggleMax('${id}')"></button>
                </div>
                <div class="window-title">${title}</div>
            </div>
            <div class="window-content">${contentFn(id)}</div>
            <div class="resize-handle r-n"></div><div class="resize-handle r-s"></div>
            <div class="resize-handle r-e"></div><div class="resize-handle r-w"></div>
            <div class="resize-handle r-se"></div>
        `;

        $('#windows-layer').appendChild(win);
        this.windows[id] = { el: win, maximized: false, prevRect: null, appId };
        
        // Event Listeners for dragging and focusing
        win.addEventListener('pointerdown', () => this.focus(id));
        const header = win.querySelector('.window-header');
        header.addEventListener('pointerdown', (e) => this.startDrag(e, id));
        header.addEventListener('dblclick', () => this.toggleMax(id));
        
        // Resize listeners
        win.querySelectorAll('.resize-handle').forEach(h => {
            h.addEventListener('pointerdown', (e) => this.startResize(e, id, h));
        });

        // Intro animation
        requestAnimationFrame(() => win.classList.add('visible'));
        this.focus(id);
        
        // Add to Taskbar
        Dock.setActive(appId, true);
        
        return id;
    }

    close(id) {
        const win = this.windows[id].el;
        win.classList.remove('visible');
        setTimeout(() => {
            win.remove();
            const appId = this.windows[id].appId;
            delete this.windows[id];
            
            // Check if other windows of this app exist
            const hasOthers = Object.values(this.windows).some(w => w.appId === appId);
            if (!hasOthers) Dock.setActive(appId, false);
            
            // Focus next top window
            const remaining = Object.keys(this.windows);
            if (remaining.length) this.focus(remaining[remaining.length - 1]);
        }, 200);
    }

    focus(id) {
        if (this.activeWindow === id) return;
        this.zIndex++;
        this.windows[id].el.style.zIndex = this.zIndex;
        this.windows[id].el.classList.remove('minimized');
        this.activeWindow = id;
        
        // Update dock visual
        $$('.dock-item').forEach(el => el.style.transform = 'scale(1)');
    }

    minimize(id) {
        this.windows[id].el.classList.add('minimized');
        this.activeWindow = null;
    }

    toggleMax(id) {
        const w = this.windows[id];
        if (w.maximized) {
            w.el.classList.remove('maximized');
            w.el.style.transform = `translate(${w.prevRect.x}px, ${w.prevRect.y}px)`;
            w.maximized = false;
        } else {
            w.prevRect = { ...w.el.getBoundingClientRect() };
            w.el.classList.add('maximized');
            w.maximized = true;
        }
    }

    startDrag(e, id) {
        if (e.target.closest('.window-controls')) return;
        if (this.windows[id].maximized) return;
        
        const win = this.windows[id].el;
        const startX = e.clientX;
        const startY = e.clientY;
        const rect = win.getBoundingClientRect();
        const offX = startX - rect.left;
        const offY = startY - rect.top;

        const onMove = (e) => {
            let x = e.clientX - offX;
            let y = e.clientY - offY;
            
            // Boundary checks
            y = Math.max(32, Math.min(y, window.innerHeight - 40));
            x = Math.max(-rect.width + 50, Math.min(x, window.innerWidth - 50));

            win.style.left = x + 'px';
            win.style.top = y + 'px';

            // Snap Assist
            this.checkSnap(e.clientX, e.clientY);
        };

        const onUp = (e) => {
            document.removeEventListener('pointermove', onMove);
            document.removeEventListener('pointerup', onUp);
            $('#snap-overlay').style.display = 'none';
            
            if (this.snapState) {
                this.applySnap(id, this.snapState);
                this.snapState = null;
            }
        };

        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', onUp);
    }

    checkSnap(x, y) {
        const overlay = $('#snap-overlay');
        const threshold = 20;
        let style = null;

        if (x < threshold) {
            style = { left: '0', top: '32px', width: '50%', height: 'calc(100% - 40px)' };
            this.snapState = 'left';
        } else if (x > window.innerWidth - threshold) {
            style = { right: '0', top: '32px', width: '50%', height: 'calc(100% - 40px)', left: 'auto' };
            this.snapState = 'right';
        } else {
            this.snapState = null;
        }

        if (style) {
            overlay.style.display = 'block';
            Object.assign(overlay.style, style);
        } else {
            overlay.style.display = 'none';
        }
    }

    applySnap(id, state) {
        const win = this.windows[id].el;
        win.style.top = '32px';
        win.style.height = 'calc(100% - 100px)'; // Account for dock
        win.style.width = '50%';
        win.style.left = state === 'left' ? '0' : '50%';
    }

    startResize(e, id, handle) {
        e.stopPropagation();
        e.preventDefault();
        const win = this.windows[id].el;
        const startRect = win.getBoundingClientRect();
        const startX = e.clientX;
        const startY = e.clientY;
        const type = handle.className.split(' ')[1];

        const onMove = (e) => {
            if (type.includes('e')) win.style.width = Math.max(200, startRect.width + (e.clientX - startX)) + 'px';
            if (type.includes('s')) win.style.height = Math.max(150, startRect.height + (e.clientY - startY)) + 'px';
        };

        const onUp = () => {
            document.removeEventListener('pointermove', onMove);
            document.removeEventListener('pointerup', onUp);
        };

        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', onUp);
    }
    
    setupInput() {
        document.addEventListener('keydown', (e) => {
            if (e.metaKey || e.ctrlKey) {
                if (e.key === '/') { e.preventDefault(); System.toggleCommandPalette(); }
                if (this.activeWindow) {
                    if (e.key === 'w') { e.preventDefault(); this.close(this.activeWindow); }
                    if (e.key === 'm') { e.preventDefault(); this.minimize(this.activeWindow); }
                    if (e.key === 'Enter') { e.preventDefault(); this.toggleMax(this.activeWindow); }
                }
            }
            if (e.key === 'Escape') {
                $('#cmd-palette').style.display = 'none';
                $('#context-menu').style.display = 'none';
            }
        });
    }
}

const WM = new WindowManager();

// --- VIRTUAL FILE SYSTEM ---
const VFS = {
    data: LS.get('vfs', {
        root: {
            type: 'folder',
            children: {
                'Documents': { type: 'folder', children: { 'welcome.txt': { type: 'file', content: 'Welcome to WebOS!' } } },
                'Images': { type: 'folder', children: {} }
            }
        }
    }),
    save: () => LS.set('vfs', VFS.data),
    get: (path) => {
        let curr = VFS.data.root;
        if (path === '/') return curr;
        const parts = path.split('/').filter(Boolean);
        for (let p of parts) {
            if (curr.children && curr.children[p]) curr = curr.children[p];
            else return null;
        }
        return curr;
    },
    create: (path, name, type, content = '') => {
        const dir = VFS.get(path);
        if (dir && !dir.children[name]) {
            dir.children[name] = { type, children: type === 'folder' ? {} : null, content };
            VFS.save();
            return true;
        }
        return false;
    }
};

// --- APPS DEFINITION ---
const Apps = {
    notes: {
        id: 'notes', icon: Icons.notes, name: 'Notes',
        open: () => {
            WM.create('notes', 'Notes', (id) => {
                const notes = LS.get('notes', [{id:1, title: 'Welcome', body: 'This is a note.'}]);
                setTimeout(() => renderNotes(id, notes), 0);
                return `<div style="display:flex; height:100%;"><div class="note-list" id="nl-${id}"></div><div class="note-editor"><input class="app-input" id="nt-${id}" placeholder="Title"><textarea class="note-area" id="nb-${id}"></textarea></div></div>`;
            });
        }
    },
    calculator: {
        id: 'calculator', icon: Icons.calc, name: 'Calculator',
        open: () => {
            WM.create('calculator', 'Calculator', (id) => {
                setTimeout(() => initCalc(id), 0);
                return `<div class="calc-grid" id="cg-${id}"></div>`;
            }, {width: 250, height: 350});
        }
    },
    calendar: {
        id: 'calendar', icon: Icons.calendar, name: 'Calendar',
        open: () => {
            WM.create('calendar', 'Calendar', (id) => {
                setTimeout(() => renderCal(id), 0);
                return `<div style="padding:10px;"><div class="cal-header"><button class="app-btn" onclick="calPrev('${id}')">&lt;</button><span id="cm-${id}"></span><button class="app-btn" onclick="calNext('${id}')">&gt;</button></div><div class="cal-grid" id="cb-${id}"></div></div>`;
            });
        }
    },
    files: {
        id: 'files', icon: Icons.files, name: 'Files',
        open: () => {
            WM.create('files', 'File Manager', (id) => {
                setTimeout(() => renderFiles(id, '/'), 0);
                return `<div style="height:100%; display:flex; flex-direction:column;"><div class="file-crumb" id="fc-${id}">/</div><div class="file-grid" id="fg-${id}"></div></div>`;
            });
        }
    },
    music: {
        id: 'music', icon: Icons.music, name: 'Music',
        open: () => {
            WM.create('music', 'Music Player', (id) => {
                setTimeout(() => initMusic(id), 0);
                return `<div style="padding:20px; text-align:center;"><div style="height:100px; background:#333; margin-bottom:10px; display:flex; align-items:flex-end; gap:2px; padding:0 10px;" id="viz-${id}"></div><h3 id="song-${id}">Ambient Track 1</h3><div style="display:flex; gap:10px; justify-content:center;"><button class="app-btn" onclick="playMusic()">Play</button><button class="app-btn" onclick="stopMusic()">Stop</button></div></div>`;
            }, {width: 300, height: 250});
        }
    },
    terminal: {
        id: 'terminal', icon: Icons.term, name: 'Terminal',
        open: () => {
            WM.create('terminal', 'Terminal', (id) => {
                setTimeout(() => initTerminal(id), 0);
                return `<div id="term-${id}" class="term-wrap"><div id="term-out-${id}" class="term-out">Welcome to WebOS v1.2\nType 'help' for available commands.\n</div><div class="term-line"><span class="term-prompt">$</span><input id="term-in-${id}" class="term-input" autocomplete="off" spellcheck="false"></div></div>`;
            }, {width: 500, height: 350});
        }
    },
    paint: {
        id: 'paint', icon: Icons.paint, name: 'Paint',
        open: () => {
            WM.create('paint', 'Paint', (id) => {
                setTimeout(() => initPaint(id), 0);
                return `<div style="height:100%; display:flex; flex-direction:column;"><div class="paint-toolbar"><div class="color-pick active" style="background:black" onclick="setPaintColor('${id}', 'black', this)"></div><div class="color-pick" style="background:red" onclick="setPaintColor('${id}', 'red', this)"></div><div class="color-pick" style="background:blue" onclick="setPaintColor('${id}', 'blue', this)"></div><div class="color-pick" style="background:green" onclick="setPaintColor('${id}', 'green', this)"></div><div class="color-pick" style="background:white" onclick="setPaintColor('${id}', 'white', this)"></div><button class="app-btn" onclick="clearPaint('${id}')">Clear</button></div><canvas id="cvs-${id}" style="flex:1; touch-action:none; width:100%; height:100%; background:white; cursor:crosshair;"></canvas></div>`;
            });
        }
    },
    settings: {
        id: 'settings', icon: Icons.settings, name: 'Settings',
        open: () => {
            WM.create('settings', 'Settings', (id) => {
                return `<div style="padding:20px;">
                    <h3>Theme</h3>
                    <button class="app-btn" onclick="System.setTheme('light')">Light</button>
                    <button class="app-btn" onclick="System.setTheme('dark')">Dark</button>
                    <h3>Wallpaper</h3>
                    <input type="color" onchange="document.getElementById('wallpaper').style.background = this.value">
                    <br><br>
                    <button class="app-btn" style="background:var(--danger)" onclick="localStorage.clear(); location.reload()">Reset All Data</button>
                    <div style="margin-top:20px; font-size:12px; opacity:0.6;">System Version: 2.1.0<br>Arnav Dugad © 2025</div>
                </div>`;
            });
        }
    }
};

// --- APP LOGIC ---

// Notes
function renderNotes(winId, notes) {
    const list = $(`#nl-${winId}`);
    list.innerHTML = `<button class="app-btn" style="width:100%; margin-bottom:5px;" onclick="addNote('${winId}')">+ New</button>` + 
        notes.map(n => `<div style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;" onclick="loadNote('${winId}', ${n.id})">${n.title || 'Untitled'}</div>`).join('');
    
    // Auto-save binding
    const save = () => {
        const id = list.dataset.curr;
        if (!id) return;
        const note = notes.find(n => n.id == id);
        if (note) {
            note.title = $(`#nt-${winId}`).value;
            note.body = $(`#nb-${winId}`).value;
            LS.set('notes', notes);
            renderNotes(winId, notes);
            list.dataset.curr = id; // restore selection
        }
    };
    $(`#nt-${winId}`).oninput = save;
    $(`#nb-${winId}`).oninput = save;
}
function addNote(winId) {
    const notes = LS.get('notes', []);
    notes.push({id: Date.now(), title: '', body: ''});
    LS.set('notes', notes);
    renderNotes(winId, notes);
}
function loadNote(winId, id) {
    const notes = LS.get('notes', []);
    const note = notes.find(n => n.id == id);
    $(`#nl-${winId}`).dataset.curr = id;
    $(`#nt-${winId}`).value = note.title;
    $(`#nb-${winId}`).value = note.body;
}

// Calculator
function initCalc(id) {
    const keys = ['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+','C','(',')'];
    const grid = $(`#cg-${id}`);
    grid.innerHTML = `<div class="calc-display" id="cd-${id}">0</div>` + 
        keys.map(k => `<button class="calc-btn ${['/','*','-','+','='].includes(k)?'op':''}" onclick="runCalc('${id}', '${k}')">${k}</button>`).join('');
}
function runCalc(id, key) {
    const disp = $(`#cd-${id}`);
    if (key === 'C') disp.innerText = '0';
    else if (key === '=') {
        try { disp.innerText = eval(disp.innerText); } catch { disp.innerText = 'Error'; }
    } else {
        disp.innerText = disp.innerText === '0' ? key : disp.innerText + key;
    }
}

// Calendar
let calDate = new Date();
function renderCal(id) {
    const y = calDate.getFullYear(), m = calDate.getMonth();
    $(`#cm-${id}`).innerText = new Date(y, m).toLocaleString('default', {month: 'long', year: 'numeric'});
    const first = new Date(y, m, 1).getDay();
    const days = new Date(y, m + 1, 0).getDate();
    let html = '';
    for(let i=0; i<first; i++) html += `<div></div>`;
    for(let i=1; i<=days; i++) {
        const isToday = i === new Date().getDate() && m === new Date().getMonth();
        html += `<div class="cal-day ${isToday?'today':''}" onclick="alert('Event for ${i}')">${i}</div>`;
    }
    $(`#cb-${id}`).innerHTML = html;
}
function calPrev(id) { calDate.setMonth(calDate.getMonth()-1); renderCal(id); }
function calNext(id) { calDate.setMonth(calDate.getMonth()+1); renderCal(id); }

// Files
function renderFiles(id, path) {
    const dir = VFS.get(path);
    $(`#fc-${id}`).innerText = path;
    const items = Object.entries(dir.children || {});
    $(`#fg-${id}`).innerHTML = items.map(([name, data]) => `
        <div class="file-item" onclick="openFile('${id}', '${path}', '${name}', '${data.type}')">
            ${data.type === 'folder' ? Icons.files : Icons.file}
            <span style="font-size:12px; text-align:center;">${name}</span>
        </div>
    `).join('') + `<div class="file-item" onclick="createFolder('${path}')" style="opacity:0.5">${Icons.files}<span>+ New</span></div>`;
}
function openFile(wid, path, name, type) {
    const newPath = path === '/' ? '/' + name : path + '/' + name;
    if (type === 'folder') renderFiles(wid, newPath);
    else Apps.notes.open(); // Simple fallback to notes for text files
}
function createFolder(path) {
    const name = prompt("Folder name:");
    if(name) { VFS.create(path, name, 'folder'); System.toast('Folder created'); }
}

// Music
let musicInterval;
function initMusic(id) {
    const viz = $(`#viz-${id}`);
    viz.innerHTML = Array(10).fill(0).map(() => `<div style="flex:1; background:#27c93f; transition:height 0.1s;"></div>`).join('');
}
function playMusic() {
    AudioEngine.init();
    if(musicInterval) return;
    const freqs = [261, 329, 392, 523, 392, 329];
    let i = 0;
    musicInterval = setInterval(() => {
        AudioEngine.playTone(freqs[i % freqs.length]);
        // Fake Viz
        $$(`#viz-music div`).forEach(d => d.style.height = Math.random()*100 + '%');
        i++;
    }, 400);
}
function stopMusic() { clearInterval(musicInterval); musicInterval = null; }

// Terminal Logic
function initTerminal(id) {
    const inp = $(`#term-in-${id}`);
    const out = $(`#term-out-${id}`);
    inp.focus();
    inp.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
            const cmd = inp.value.trim();
            out.innerText += `\n$ ${cmd}\n`;
            inp.value = '';
            processCmd(cmd, out);
            out.scrollTop = out.scrollHeight;
        }
    });
    $(`#term-${id}`).addEventListener('click', () => inp.focus());
}
function processCmd(cmd, out) {
    const args = cmd.split(' ');
    switch(args[0].toLowerCase()) {
        case 'help': out.innerText += 'Available: help, clear, date, echo, whoami, reboot'; break;
        case 'clear': out.innerText = ''; break;
        case 'date': out.innerText += new Date().toString(); break;
        case 'echo': out.innerText += args.slice(1).join(' '); break;
        case 'whoami': out.innerText += 'root'; break;
        case 'reboot': location.reload(); break;
        case '': break;
        default: out.innerText += `Command not found: ${args[0]}`;
    }
}

// Paint Logic
const Paints = {};
function initPaint(id) {
    const cvs = $(`#cvs-${id}`);
    const ctx = cvs.getContext('2d');
    const rect = cvs.getBoundingClientRect();
    cvs.width = rect.width; cvs.height = rect.height;
    
    Paints[id] = { color: 'black', isDrawing: false };
    
    const start = (e) => {
        Paints[id].isDrawing = true;
        ctx.beginPath();
        const {x, y} = getPos(e, cvs);
        ctx.moveTo(x, y);
    };
    const move = (e) => {
        if(!Paints[id].isDrawing) return;
        const {x, y} = getPos(e, cvs);
        ctx.strokeStyle = Paints[id].color;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineTo(x, y);
        ctx.stroke();
    };
    const end = () => { Paints[id].isDrawing = false; };
    
    cvs.addEventListener('pointerdown', start);
    cvs.addEventListener('pointermove', move);
    cvs.addEventListener('pointerup', end);
    cvs.addEventListener('pointerout', end);
}
function getPos(e, cvs) {
    const r = cvs.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
}
function setPaintColor(id, color, btn) {
    Paints[id].color = color;
    btn.parentElement.querySelectorAll('.color-pick').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}
function clearPaint(id) {
    const cvs = $(`#cvs-${id}`);
    cvs.getContext('2d').clearRect(0,0,cvs.width,cvs.height);
}


// --- SYSTEM UI ---
const System = {
    init: () => {
        System.updateClock();
        setInterval(System.updateClock, 1000);
        Dock.render();
        Desktop.render();
        
        // Theme
        const theme = LS.get('theme', 'light');
        System.setTheme(theme);

        // Lock Screen check
        $('#pin-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (e.target.value === '1234') {
                    $('#lock-screen').classList.add('unlocked');
                    AudioEngine.playTone(600, 'sine', 0.1);
                    AudioEngine.playTone(800, 'sine', 0.1);
                } else {
                    e.target.style.border = '1px solid red';
                    AudioEngine.playTone(150, 'sawtooth', 0.3);
                }
            }
        });

        // Context Menu
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const cm = $('#context-menu');
            cm.style.display = 'block';
            cm.style.left = e.clientX + 'px';
            cm.style.top = e.clientY + 'px';
        });
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#context-menu')) $('#context-menu').style.display = 'none';
        });
    },
    updateClock: () => {
        const d = new Date();
        $('#top-clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        $('#top-date').innerText = d.toLocaleDateString([], {month:'short', day:'numeric'});
        $('#lock-clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        $('#lock-date').innerText = d.toLocaleDateString([], {weekday:'long', month:'long', day:'numeric'});
    },
    toast: (msg) => {
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerText = msg;
        $('#toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    },
    lock: () => {
        $('#lock-screen').classList.remove('unlocked');
        $('#pin-input').value = '';
    },
    setTheme: (mode) => {
        document.documentElement.setAttribute('data-theme', mode);
        LS.set('theme', mode);
    },
    toggleTheme: () => {
        const curr = document.documentElement.getAttribute('data-theme');
        System.setTheme(curr === 'dark' ? 'light' : 'dark');
    },
    toggleCommandPalette: () => {
        const cp = $('#cmd-palette');
        const inp = $('#cmd-input');
        if (cp.style.display === 'flex') {
            cp.style.display = 'none';
        } else {
            cp.style.display = 'flex';
            inp.value = '';
            inp.focus();
            System.renderCommands('');
        }
    },
    renderCommands: (query) => {
        const res = $('#cmd-results');
        const cmds = [
            { txt: 'Open Notes', act: Apps.notes.open },
            { txt: 'Open Calculator', act: Apps.calculator.open },
            { txt: 'Open Terminal', act: Apps.terminal.open },
            { txt: 'Open Paint', act: Apps.paint.open },
            { txt: 'Toggle Theme', act: System.toggleTheme },
            { txt: 'Lock Screen', act: System.lock }
        ];
        res.innerHTML = cmds
            .filter(c => c.txt.toLowerCase().includes(query.toLowerCase()))
            .map(c => `<div class="cmd-item" onclick="this.parentElement.parentElement.style.display='none'; (${c.act})()">${c.txt}</div>`)
            .join('');
    }
};

$('#cmd-input').addEventListener('input', (e) => System.renderCommands(e.target.value));
$('#cmd-input').addEventListener('keydown', (e) => {
    if(e.key === 'Enter') $('#cmd-results').firstElementChild?.click();
});

// --- DOCK ---
const Dock = {
    render: () => {
        $('#dock').innerHTML = Object.values(Apps).map(app => `
            <div class="dock-item" id="dock-${app.id}" onclick="Apps['${app.id}'].open()">
                ${app.icon}
            </div>
        `).join('');
    },
    setActive: (appId, isActive) => {
        const el = $(`#dock-${appId}`);
        if(el) isActive ? el.classList.add('active') : el.classList.remove('active');
    }
};

// --- DESKTOP ---
const Desktop = {
    icons: LS.get('desktop_icons', ['notes', 'files', 'terminal', 'paint']),
    render: () => {
        const grid = $('#desktop-grid');
        grid.innerHTML = Desktop.icons.map((id, index) => {
            const app = Apps[id];
            // Simple grid positioning logic
            const col = Math.floor(index / 8);
            const row = index % 8;
            return `<div class="desktop-icon" style="top:${row*90 + 10}px; left:${col*90 + 10}px;" 
                onclick="Apps.${id}.open()" 
                onpointerdown="Desktop.startDrag(event, this)">
                ${app.icon}
                <span>${app.name}</span>
            </div>`
        }).join('');
        
        // Selection Box Logic
        let isSelecting = false;
        let startX, startY;
        const box = $('#selection-box');
        
        document.addEventListener('pointerdown', (e) => {
            if(e.target.closest('.desktop-icon') || e.target.closest('.window') || e.target.closest('#dock-container')) return;
            isSelecting = true;
            startX = e.clientX;
            startY = e.clientY;
            box.style.display = 'block';
            box.style.width = '0'; box.style.height = '0';
            box.style.left = startX + 'px'; box.style.top = startY + 'px';
        });
        
        document.addEventListener('pointermove', (e) => {
            if(!isSelecting) return;
            const w = e.clientX - startX;
            const h = e.clientY - startY;
            box.style.left = (w < 0 ? e.clientX : startX) + 'px';
            box.style.top = (h < 0 ? e.clientY : startY) + 'px';
            box.style.width = Math.abs(w) + 'px';
            box.style.height = Math.abs(h) + 'px';
        });
        
        document.addEventListener('pointerup', () => {
            isSelecting = false;
            box.style.display = 'none';
        });
    },
    startDrag: (e, el) => {
        e.stopPropagation();
        const startX = e.clientX;
        const startY = e.clientY;
        const rect = el.getBoundingClientRect();
        const offX = startX - rect.left;
        const offY = startY - rect.top;
        
        el.style.zIndex = 100;
        
        const move = (ev) => {
            el.style.left = (ev.clientX - offX) + 'px';
            el.style.top = (ev.clientY - offY - 32) + 'px'; // adjust for top bar
        };
        const up = () => {
            document.removeEventListener('pointermove', move);
            document.removeEventListener('pointerup', up);
            el.style.zIndex = '';
        };
        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
    }
};

// Init
window.onload = System.init;

</script>
</body>
</html>